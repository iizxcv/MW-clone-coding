name: Git Commit/PR → Notion DB

on:
  # 모든 브랜치 push 이벤트
  push:

  # PR 이벤트 (생성/업데이트/병합)
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  update-notion:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Git 레포 체크아웃
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      # 2️⃣ jq 설치
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3️⃣ 커밋/PR 정보 가져오기
      - name: Get last commit/PR info
        id: get_info
        run: |
          # 브랜치 이름
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
            TITLE="${{ github.event.pull_request.title }}"
            # PR 본문
            BODY="${{ github.event.pull_request.body }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            DATE_ISO="${{ github.event.pull_request.created_at }}"
          else
            # push 이벤트
            BRANCH_NAME="${GITHUB_REF_NAME#refs/heads/}"
            # 최신 커밋 정보
            git log -1 --pretty=format:'%H%n%an%n%s%n%b%n%cI' > last_commit.txt
            readarray -t arr < last_commit.txt
            SHA="${arr[0]}"
            AUTHOR="${arr[1]}"
            TITLE="${arr[2]}"
            DATE_ISO="${arr[-1]}"
            BODY=$(printf "%s\n" "${arr[@]:3:${#arr[@]}-4}")
          fi

          # 환경변수 등록
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "BODY=$BODY" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "DATE_ISO=$DATE_ISO" >> $GITHUB_ENV

      # 4️⃣ Notion DB에 새 페이지 생성
      - name: Add to Notion DB
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          TITLE: ${{ env.TITLE }}
          BODY: ${{ env.BODY }}
          AUTHOR: ${{ env.AUTHOR }}
          DATE_ISO: ${{ env.DATE_ISO }}
          BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          # 본문 안전하게 JSON 문자열로 변환
          BODY_JSON=$(jq -Rn --arg str "$BODY" '$str')

          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY_JSON" \
            --arg author "$AUTHOR" \
            --arg date_iso "$DATE_ISO" \
            --arg branch "$BRANCH" \
            '{
              parent: { database_id: "'$NOTION_DATABASE_ID'" },
              properties: {
                "Title": { "title": [{ "text": { "content": $title } }] },
                "Body": { "rich_text": [{ "text": { "content": $body } }] },
                "Author": { "rich_text": [{ "text": { "content": $author } }] },
                "Commit Date": { "date": { "start": $date_iso } },
                "Branch": { "select": { "name": $branch } }
              }
            }')

          # Notion API 호출
          response=$(echo "$JSON_PAYLOAD" | curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d @-)

          echo "Notion API response: $response"
